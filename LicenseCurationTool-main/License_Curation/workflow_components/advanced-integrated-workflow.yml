name: Advanced ORT License Curation with Policy Enforcement

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM for license change monitoring

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  advanced-license-curation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Install Python dependencies
      run: |
        pip install python-inspector openai pyyaml spdx-tools scancode-toolkit requests
        python-inspector --version
        scancode --version

    - name: Download ORT
      run: |
        ORT_VERSION="70.0.1"
        wget -q https://github.com/oss-review-toolkit/ort/releases/download/${ORT_VERSION}/ort-${ORT_VERSION}.tgz
        tar -xzf ort-${ORT_VERSION}.tgz
        echo "${GITHUB_WORKSPACE}/ort-${ORT_VERSION}/bin" >> $GITHUB_PATH

    - name: Verify ORT installation
      run: |
        ort --version
        java -version

    - name: Clean previous results
      run: |
        rm -rf ort-results scancode-results uncertain-packages enhanced-spdx pypi-licenses policy-reports license-history alternatives
        mkdir -p ort-results scancode-results uncertain-packages enhanced-spdx pypi-licenses policy-reports license-history alternatives

    # ====== STAGE 1: ORT Analysis ======
    - name: Run ORT Analyzer
      run: |
        echo "üîç Stage 1: Running ORT Analyzer..."
        ort analyze -i . -o ort-results/analyzer
      continue-on-error: true

    - name: Run ORT Advisor
      run: |
        echo "üîç Stage 1: Running ORT Advisor..."
        ort advise \
          -i ort-results/analyzer/analyzer-result.yml \
          -o ort-results/advisor \
          --advisors OSV
      continue-on-error: true

    - name: Generate Initial ORT Reports
      run: |
        echo "üìä Stage 1: Generating initial ORT reports..."

        # Determine the latest result file
        if [ -f ort-results/advisor/advise-result.yml ]; then
          INPUT_FILE="ort-results/advisor/advise-result.yml"
        else
          INPUT_FILE="ort-results/analyzer/analyzer-result.yml"
        fi

        ort report \
          -i "$INPUT_FILE" \
          -o ort-results/reporter \
          -f WebApp,StaticHtml,CycloneDx,SpdxDocument

    # ====== STAGE 2: Policy Compliance Check ======
    - name: Check License Policy Compliance
      run: |
        echo "üîí Stage 2: Checking license policy compliance..."

        # Check if ORT results exist
        if [ ! -f ort-results/analyzer/analyzer-result.yml ]; then
          echo "‚ùå ORT analyzer results not found!"
          exit 0
        fi

        # Run policy checker
        python3 workflow_components/scripts/policy_checker.py \
          --policy workflow_components/config/company-policy.yml \
          --ort-results ort-results/analyzer/analyzer-result.yml \
          --output policy-reports/policy-compliance-report.html \
          --json policy-reports/policy-results.json

        echo "‚úÖ Policy compliance check complete"
      continue-on-error: true

    - name: Display policy compliance summary
      run: |
        if [ -f policy-reports/policy-results.json ]; then
          echo "üìä Policy Compliance Summary:"

          # Extract summary using Python
          python3 << 'EOF'
import json
import sys

try:
    with open('policy-reports/policy-results.json', 'r') as f:
        data = json.load(f)
        summary = data.get('summary', {})

        print(f"  ‚úÖ Approved:    {summary.get('approved', 0)}")
        print(f"  ‚ö†Ô∏è  Conditional: {summary.get('conditional', 0)}")
        print(f"  ‚ùå Forbidden:   {summary.get('forbidden', 0)}")
        print(f"  ‚ùì Unknown:     {summary.get('unknown', 0)}")
        print(f"  üìà Compliance Score: {summary.get('compliance_score', 0)}%")

        # Add to GitHub summary
        with open(process.env.get('GITHUB_STEP_SUMMARY', '/dev/null'), 'a') as summary_file:
            summary_file.write("\n## üìã License Policy Compliance\n\n")
            summary_file.write(f"**Compliance Score:** {summary.get('compliance_score', 0)}%\n\n")
            summary_file.write(f"- ‚úÖ Approved: {summary.get('approved', 0)}\n")
            summary_file.write(f"- ‚ö†Ô∏è Conditional: {summary.get('conditional', 0)}\n")
            summary_file.write(f"- ‚ùå Forbidden: {summary.get('forbidden', 0)}\n")
            summary_file.write(f"- ‚ùì Unknown: {summary.get('unknown', 0)}\n\n")

        # Fail if forbidden packages found
        if summary.get('forbidden', 0) > 0:
            print("\n‚ùå FORBIDDEN PACKAGES DETECTED!")
            sys.exit(1)

except Exception as e:
    print(f"Error reading policy results: {e}")
    sys.exit(0)
EOF
        fi
      continue-on-error: true

    # ====== STAGE 3: License Change Monitoring ======
    - name: Initialize license history (first run)
      run: |
        echo "üîç Stage 3: Initializing license change tracking..."

        # Check if history file exists
        if [ ! -f .ort/license-history.json ]; then
          echo "Initializing new license history database..."
          python3 workflow_components/scripts/license_change_monitor.py --init \
            --ort-results ort-results/analyzer/analyzer-result.yml \
            --history .ort/license-history.json
        else
          echo "License history already exists"
        fi
      continue-on-error: true

    - name: Check for license changes
      run: |
        echo "üîç Stage 3: Checking for license changes..."

        # Only check if history exists
        if [ -f .ort/license-history.json ]; then
          python3 workflow_components/scripts/license_change_monitor.py --check \
            --ort-results ort-results/analyzer/analyzer-result.yml \
            --policy workflow_components/config/company-policy.yml \
            --output policy-reports/license-changes-report.html \
            --json license-history/changes.json

          echo "‚úÖ License change monitoring complete"
        else
          echo "‚ö†Ô∏è  No license history found, skipping change detection"
        fi
      continue-on-error: true

    - name: Display license change summary
      run: |
        if [ -f license-history/changes.json ]; then
          echo "üìä License Change Summary:"

          python3 << 'EOF'
import json
import sys

try:
    with open('license-history/changes.json', 'r') as f:
        data = json.load(f)
        changes = data.get('changes', [])

        critical = sum(1 for c in changes if c.get('severity') == 'critical')
        high = sum(1 for c in changes if c.get('severity') == 'high')
        medium = sum(1 for c in changes if c.get('severity') == 'medium')
        low = sum(1 for c in changes if c.get('severity') == 'low')

        print(f"  Total changes detected: {len(changes)}")
        print(f"  ‚õî Critical: {critical}")
        print(f"  ‚ö†Ô∏è  High:     {high}")
        print(f"  üìã Medium:   {medium}")
        print(f"  ‚ÑπÔ∏è  Low:      {low}")

        # Add to GitHub summary
        with open(os.environ.get('GITHUB_STEP_SUMMARY', '/dev/null'), 'a') as summary_file:
            summary_file.write("\n## üîÑ License Changes Detected\n\n")
            summary_file.write(f"Total changes: {len(changes)}\n\n")
            summary_file.write(f"- ‚õî Critical: {critical}\n")
            summary_file.write(f"- ‚ö†Ô∏è High: {high}\n")
            summary_file.write(f"- üìã Medium: {medium}\n")
            summary_file.write(f"- ‚ÑπÔ∏è Low: {low}\n\n")

        # Fail if critical changes detected
        if critical > 0:
            print("\n‚ùå CRITICAL LICENSE CHANGES DETECTED!")
            for change in changes:
                if change.get('severity') == 'critical':
                    pkg = change.get('package_name', 'Unknown')
                    prev_lic = change.get('previous_license', 'Unknown')
                    curr_lic = change.get('current_license', 'Unknown')
                    print(f"   {pkg}: {prev_lic} ‚Üí {curr_lic}")
            sys.exit(1)

except Exception as e:
    print(f"Error reading license changes: {e}")
    sys.exit(0)
EOF
        fi
      continue-on-error: true

    # ====== STAGE 4: Find Alternative Packages ======
    - name: Find alternatives for forbidden packages
      run: |
        echo "üîÑ Stage 4: Finding alternative packages for forbidden licenses..."

        if [ ! -f policy-reports/policy-results.json ]; then
          echo "No policy results found, skipping alternative search"
          exit 0
        fi

        # Extract forbidden packages and find alternatives
        python3 << 'EOF'
import json
import subprocess
import sys

try:
    with open('policy-reports/policy-results.json', 'r') as f:
        data = json.load(f)

    forbidden_packages = [
        pkg for pkg in data.get('packages', [])
        if pkg.get('policy_status') == 'forbidden'
    ]

    if not forbidden_packages:
        print("‚úÖ No forbidden packages found")
        sys.exit(0)

    print(f"Found {len(forbidden_packages)} forbidden packages")

    # Find alternatives for each forbidden package
    for pkg in forbidden_packages[:5]:  # Limit to first 5 to avoid timeout
        pkg_name = pkg.get('package_name', '')
        pkg_type = pkg.get('package_type', 'PyPI')
        forbidden_license = pkg.get('detected_license', '')

        print(f"\nSearching alternatives for: {pkg_name} ({forbidden_license})")

        output_file = f"alternatives/alternatives-{pkg_name.replace('/', '-')}.html"

        cmd = [
            'python3', 'workflow_components/scripts/alternative_package_finder.py',
            '--package', pkg_name,
            '--type', pkg_type,
            '--forbidden-license', forbidden_license,
            '--policy', 'workflow_components/config/company-policy.yml',
            '--output', output_file,
            '--max-results', '5'
        ]

        try:
            subprocess.run(cmd, check=False, timeout=60)
            print(f"  ‚úì Generated alternatives report: {output_file}")
        except Exception as e:
            print(f"  ‚úó Error finding alternatives: {e}")

except Exception as e:
    print(f"Error processing forbidden packages: {e}")
    sys.exit(0)
EOF

        echo "‚úÖ Alternative package search complete"
      continue-on-error: true

    # ====== STAGE 5: Extract Uncertain Packages ======
    - name: Extract packages with uncertain licenses
      run: |
        echo "üîç Stage 5: Extracting packages with missing/uncertain licenses..."
        python extract_uncertain_packages.py \
          --ort-result ort-results/analyzer/analyzer-result.yml \
          --output-dir uncertain-packages
      continue-on-error: true

    - name: Display uncertain package statistics
      run: |
        if [ -f uncertain-packages/extraction-stats.txt ]; then
          echo "üìä Uncertain Package Statistics:"
          cat uncertain-packages/extraction-stats.txt

          # Add to GitHub summary
          echo "## üì¶ Package License Coverage" >> $GITHUB_STEP_SUMMARY
          cat uncertain-packages/extraction-stats.txt >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true

    # ====== STAGE 6: Fetch PyPI Licenses ======
    - name: Fetch licenses from PyPI API
      run: |
        echo "üåê Stage 6: Fetching missing licenses from PyPI API..."

        # Check if there are uncertain packages to fetch
        if [ ! -f uncertain-packages/uncertain-packages.json ]; then
          echo "‚ö†Ô∏è  No uncertain packages found, skipping PyPI fetch..."
          exit 0
        fi

        # Check if there are actually uncertain packages in the file
        UNCERTAIN_COUNT=$(python3 -c "import json; data=json.load(open('uncertain-packages/uncertain-packages.json')); print(len(data))" 2>/dev/null || echo "0")

        if [ "$UNCERTAIN_COUNT" = "0" ]; then
          echo "‚úì No uncertain packages to fetch from PyPI"
          exit 0
        fi

        echo "Found $UNCERTAIN_COUNT packages with missing licenses"

        # Run PyPI license fetcher
        python3 fetch_pypi_licenses.py \
          ort-results/analyzer/analyzer-result.yml \
          --fetch \
          --json \
          --csv \
          --curations \
          --html \
          --output-dir pypi-licenses

        echo "‚úÖ PyPI license fetch complete"
      continue-on-error: true

    - name: Display PyPI fetch statistics
      run: |
        if [ -f pypi-licenses/pypi-fetch-stats.txt ]; then
          echo "üìä PyPI License Fetch Statistics:"
          cat pypi-licenses/pypi-fetch-stats.txt

          # Add to GitHub summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üåê PyPI License Fetch Results" >> $GITHUB_STEP_SUMMARY
          cat pypi-licenses/pypi-fetch-stats.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true

    # ====== STAGE 7: ScanCode Deep Scan (Optimized) ======
    - name: Create ScanCode scan script
      run: |
        cat > scan_packages.py << 'EOF'
        import json
        import subprocess
        import os
        from pathlib import Path

        # Load uncertain packages JSON for source URLs
        with open('uncertain-packages/uncertain-packages.json', 'r') as f:
            uncertain = json.load(f)

        # Load PyPI fetch results to skip packages with licenses already found
        pypi_found_ids = set()
        if Path('pypi-licenses/pypi-licenses-found.json').exists():
            with open('pypi-licenses/pypi-licenses-found.json', 'r') as f:
                pypi_data = json.load(f)
                pypi_found_ids = {pkg['id'] for pkg in pypi_data.get('packages', [])}
                print(f"PyPI found licenses for {len(pypi_found_ids)} packages - skipping ScanCode for these")

        # Load scan list
        with open('uncertain-packages/scan-list.txt', 'r') as f:
            scan_ids = [line.strip() for line in f]

        downloads_dir = Path('downloaded-packages')
        downloads_dir.mkdir(exist_ok=True)

        scanned = 0
        skipped_pypi = 0
        for pkg in uncertain:
            if pkg['id'] not in scan_ids:
                continue

            # Skip if PyPI already found a license
            if pkg['id'] in pypi_found_ids:
                print(f"Skipping {pkg['name']} - license found in PyPI")
                skipped_pypi += 1
                continue

            pkg_name = pkg['name'].replace('/', '-').replace(':', '-')
            version = pkg['version']
            source_url = pkg.get('source_artifact_url', '')

            if not source_url:
                print(f"Warning: No source URL for {pkg_name}, skipping...")
                continue

            # Download package
            download_path = downloads_dir / f"{pkg_name}-{version}"
            print(f"Downloading {pkg_name}...")

            try:
                # Download and extract
                subprocess.run(['wget', '-q', '-O', f'{download_path}.tar.gz', source_url],
                              check=True, timeout=60)
                subprocess.run(['tar', '-xzf', f'{download_path}.tar.gz', '-C', str(downloads_dir)],
                              check=False, timeout=30)

                # Run ScanCode with multiple output formats
                print(f"Scanning {pkg_name}...")
                base_output = f"scancode-results/{pkg_name}-{version}"

                result = subprocess.run([
                    'scancode',
                    '-clpieu',  # copyright, license, package, info, email, url
                    '--json', f"{base_output}.json",
                    '--html', f"{base_output}.html",
                    '--yaml', f"{base_output}.yml",
                    '--timeout', '120',
                    '--max-depth', '3',
                    str(download_path)
                ], capture_output=True, text=True, timeout=300)

                if result.returncode == 0:
                    print(f"Successfully scanned {pkg_name}")
                    scanned += 1
                else:
                    print(f"Warning: ScanCode returned non-zero for {pkg_name}")

            except subprocess.TimeoutExpired:
                print(f"Timeout scanning {pkg_name}")
            except Exception as e:
                print(f"Error processing {pkg_name}: {e}")

            # Limit total scans
            if scanned >= 20:
                print(f"Reached scan limit of 20 packages")
                break

        print(f"\n=== ScanCode Summary ===")
        print(f"Packages scanned: {scanned}")
        print(f"Packages skipped (license found in PyPI): {skipped_pypi}")
        print(f"Total packages processed: {scanned + skipped_pypi}")
        EOF
      continue-on-error: true

    - name: Download and scan uncertain packages
      run: |
        echo "üîç Stage 7: Running ScanCode on uncertain packages..."

        # Check if there are uncertain packages to scan
        if [ ! -f uncertain-packages/uncertain-package-ids.txt ]; then
          echo "‚ö†Ô∏è  No uncertain packages found, skipping ScanCode..."
          exit 0
        fi

        # Read uncertain package IDs
        UNCERTAIN_COUNT=$(wc -l < uncertain-packages/uncertain-package-ids.txt)
        echo "Found $UNCERTAIN_COUNT packages requiring deep scanning"

        # Limit to first 20 packages to avoid timeout
        SCAN_LIMIT=20
        if [ $UNCERTAIN_COUNT -gt $SCAN_LIMIT ]; then
          echo "‚ö†Ô∏è  Limiting ScanCode to first $SCAN_LIMIT packages (of $UNCERTAIN_COUNT)"
          head -n $SCAN_LIMIT uncertain-packages/uncertain-package-ids.txt > uncertain-packages/scan-list.txt
        else
          cp uncertain-packages/uncertain-package-ids.txt uncertain-packages/scan-list.txt
        fi

        # Run the scan script
        python3 scan_packages.py
      timeout-minutes: 30
      continue-on-error: true

    # ====== STAGE 8: Merge ScanCode Results ======
    - name: Generate ScanCode summary reports
      run: |
        echo "üìä Stage 8a: Generating ScanCode HTML and YAML summary reports..."

        # Check if ScanCode results exist
        if [ -d scancode-results ] && [ "$(ls -A scancode-results)" ]; then
          python3 generate_scancode_reports.py scancode-results
          echo "‚úÖ ScanCode summary reports generated"
        else
          echo "‚ö†Ô∏è  No ScanCode results found, skipping report generation"
        fi
      continue-on-error: true

    - name: Merge ScanCode results into SPDX
      run: |
        echo "üîÑ Stage 8b: Merging ScanCode results into SPDX..."

        python merge_scancode_to_spdx.py \
          --spdx ort-results/reporter/bom.spdx.yml \
          --scancode scancode-results/ \
          --output enhanced-spdx/bom-enhanced.spdx.json
      continue-on-error: true

    - name: Validate enhanced SPDX
      run: |
        if [ -f enhanced-spdx/bom-enhanced.spdx.json ]; then
          echo "‚úÖ Validating enhanced SPDX document..."
          pyspdxtools -i enhanced-spdx/bom-enhanced.spdx.json --validate || true

          # Also fix any issues with our validator
          python spdx-validation-fixer.py \
            -i enhanced-spdx/bom-enhanced.spdx.json \
            -o enhanced-spdx/bom-enhanced-fixed.spdx.json
        fi
      continue-on-error: true

    # ====== STAGE 9: AI-Powered Curation Reports ======
    - name: Check AI curation prerequisites
      run: |
        echo "üîç Checking prerequisites for AI curation..."

        echo "Checking required files:"
        [ -f ort-results/analyzer/analyzer-result.yml ] && echo "  ‚úì ORT analyzer results found" || echo "  ‚úó ORT analyzer results missing"
        [ -f uncertain-packages/uncertain-packages.json ] && echo "  ‚úì Uncertain packages found" || echo "  ‚úó Uncertain packages missing"
        [ -f ort-results/reporter/bom.spdx.yml ] && echo "  ‚úì SPDX document found" || echo "  ‚úó SPDX document missing"

        echo "Checking Azure OpenAI configuration:"
        [ -n "$AZURE_OPENAI_API_KEY" ] && echo "  ‚úì API key configured" || echo "  ‚úó API key missing"
        [ -n "$AZURE_OPENAI_ENDPOINT" ] && echo "  ‚úì Endpoint configured" || echo "  ‚úó Endpoint missing"
      env:
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      continue-on-error: true

    - name: Generate main ORT curation report
      env:
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      run: |
        echo "ü§ñ Stage 9a: Generating main ORT curation report..."

        # Check if ORT results exist
        if [ ! -f ort-results/analyzer/analyzer-result.yml ]; then
          echo "‚ùå ORT analyzer results not found!"
          exit 0
        fi

        # Check Azure credentials
        if [ -z "$AZURE_OPENAI_API_KEY" ]; then
          echo "‚ö†Ô∏è  AZURE_OPENAI_API_KEY not set, skipping AI report..."
          exit 0
        fi

        # Run the original ORT curation script
        echo "Running ort_curation_script_html.py..."
        python3 ort_curation_script_html.py 2>&1 | tee ort-curation.log

        # Check if report was generated
        LATEST_REPORT=$(ls -t curation-report-*.html 2>/dev/null | head -n 1)
        if [ -n "$LATEST_REPORT" ] && [ -f "$LATEST_REPORT" ]; then
          echo "‚úÖ Main curation report generated: $LATEST_REPORT"
          echo "   Size: $(wc -c < "$LATEST_REPORT") bytes"

          # Create a consistent name for deployment
          cp "$LATEST_REPORT" curation-report-main.html
          echo "‚úÖ Copied to curation-report-main.html for deployment"
        else
          echo "‚ö†Ô∏è  No curation report generated, check ort-curation.log"
          cat ort-curation.log || true
        fi
      continue-on-error: true

    - name: Generate enhanced conflict analysis report
      env:
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      run: |
        echo "ü§ñ Stage 9b: Generating enhanced conflict analysis..."

        # Only run if there are uncertain packages
        if [ ! -f uncertain-packages/uncertain-packages.json ]; then
          echo "‚úì No uncertain packages found - skipping conflict analysis"
          exit 0
        fi

        # Check if there are actually uncertain packages in the file
        UNCERTAIN_COUNT=$(python3 -c "import json; data=json.load(open('uncertain-packages/uncertain-packages.json')); print(len(data))" 2>/dev/null || echo "0")

        if [ "$UNCERTAIN_COUNT" = "0" ]; then
          echo "‚úì No uncertain packages to analyze"
          exit 0
        fi

        echo "Found $UNCERTAIN_COUNT uncertain packages requiring analysis"

        # Check Azure credentials
        if [ -z "$AZURE_OPENAI_API_KEY" ] || [ -z "$AZURE_OPENAI_ENDPOINT" ]; then
          echo "‚ö†Ô∏è  Azure OpenAI not configured, skipping conflict analysis..."
          exit 0
        fi

        # Use enhanced SPDX if available
        SPDX_INPUT="ort-results/reporter/bom.spdx.yml"
        if [ -f enhanced-spdx/bom-enhanced-fixed.spdx.json ]; then
          SPDX_INPUT="enhanced-spdx/bom-enhanced-fixed.spdx.json"
          echo "Using enhanced SPDX: $SPDX_INPUT"
        else
          echo "Using original SPDX: $SPDX_INPUT"
        fi

        # Run enhanced conflict analysis
        echo "Running enhanced_ai_curation.py..."
        python3 enhanced_ai_curation.py \
          --ort-results ort-results/analyzer/analyzer-result.yml \
          --spdx-doc "$SPDX_INPUT" \
          --uncertain-packages uncertain-packages/uncertain-packages.json \
          --output curation-report-conflicts.html 2>&1 | tee conflict-analysis.log

        # Verify output
        if [ -f curation-report-conflicts.html ] && [ -s curation-report-conflicts.html ]; then
          echo "‚úÖ Conflict analysis report generated ($(wc -c < curation-report-conflicts.html) bytes)"
        else
          echo "‚ö†Ô∏è  Conflict analysis failed, check conflict-analysis.log"
          cat conflict-analysis.log || true
        fi
      continue-on-error: true

    - name: Generate AI missing licenses report
      env:
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      run: |
        echo "ü§ñ Stage 9c: Generating AI missing licenses analysis..."

        # Only run if there are uncertain packages
        if [ ! -f uncertain-packages/uncertain-packages.json ]; then
          echo "‚úì No uncertain packages found - skipping missing licenses analysis"
          exit 0
        fi

        # Check if there are actually uncertain packages in the file
        UNCERTAIN_COUNT=$(python3 -c "import json; data=json.load(open('uncertain-packages/uncertain-packages.json')); print(len(data))" 2>/dev/null || echo "0")

        if [ "$UNCERTAIN_COUNT" = "0" ]; then
          echo "‚úì No uncertain packages to analyze"
          exit 0
        fi

        echo "Found $UNCERTAIN_COUNT uncertain packages - analyzing for missing licenses"

        # Check Azure credentials
        if [ -z "$AZURE_OPENAI_API_KEY" ]; then
          echo "‚ö†Ô∏è  Azure OpenAI not configured, skipping missing licenses analysis..."
          exit 0
        fi

        # Run AI missing licenses analyzer
        echo "Running ai_missing_licenses_analyzer.py..."
        python3 ai_missing_licenses_analyzer.py \
          uncertain-packages/uncertain-packages.json \
          curation-report-missing-licenses.html 2>&1 | tee missing-licenses-analysis.log

        # Verify output
        if [ -f curation-report-missing-licenses.html ] && [ -s curation-report-missing-licenses.html ]; then
          echo "‚úÖ Missing licenses analysis report generated ($(wc -c < curation-report-missing-licenses.html) bytes)"
        else
          echo "‚ö†Ô∏è  Missing licenses analysis failed, check missing-licenses-analysis.log"
          cat missing-licenses-analysis.log || true
        fi
      continue-on-error: true

    - name: Generate multi-layer license comparison report
      run: |
        echo "üîç Stage 9d: Generating multi-layer license comparison report..."

        # Check if ORT results exist
        if [ ! -f ort-results/analyzer/analyzer-result.yml ]; then
          echo "‚ö†Ô∏è  ORT analyzer results not found, skipping comparison report..."
          exit 0
        fi

        # Determine which files are available
        PYPI_RESULTS=""
        if [ -f pypi-licenses/pypi-licenses-full.json ]; then
          PYPI_RESULTS="--pypi-results pypi-licenses/pypi-licenses-full.json"
          echo "  ‚úì PyPI results found"
        fi

        SCANCODE_DIR=""
        if [ -d scancode-results ] && [ "$(ls -A scancode-results)" ]; then
          SCANCODE_DIR="--scancode-dir scancode-results"
          echo "  ‚úì ScanCode results found"
        fi

        UNCERTAIN_PACKAGES=""
        if [ -f uncertain-packages/uncertain-packages.json ]; then
          UNCERTAIN_PACKAGES="--uncertain-packages uncertain-packages/uncertain-packages.json"
          echo "  ‚úì Uncertain packages list found"
        fi

        SPDX_DOC=""
        if [ -f enhanced-spdx/bom-enhanced-fixed.spdx.json ]; then
          SPDX_DOC="--spdx enhanced-spdx/bom-enhanced-fixed.spdx.json"
          echo "  ‚úì Enhanced SPDX found"
        elif [ -f enhanced-spdx/bom-enhanced.spdx.json ]; then
          SPDX_DOC="--spdx enhanced-spdx/bom-enhanced.spdx.json"
          echo "  ‚úì Enhanced SPDX found"
        fi

        # Run comparison report generator
        echo "Running generate_license_comparison.py..."
        python3 generate_license_comparison.py \
          --ort-result ort-results/analyzer/analyzer-result.yml \
          $PYPI_RESULTS \
          $SCANCODE_DIR \
          $UNCERTAIN_PACKAGES \
          $SPDX_DOC \
          --output license-comparison.html 2>&1 | tee license-comparison.log

        # Verify output
        if [ -f license-comparison.html ] && [ -s license-comparison.html ]; then
          echo "‚úÖ License comparison report generated ($(wc -c < license-comparison.html) bytes)"
        else
          echo "‚ö†Ô∏è  License comparison generation failed, check license-comparison.log"
          cat license-comparison.log || true
        fi
      continue-on-error: true

    - name: Generate AI multi-layer resolution report
      env:
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
        AZURE_OPENAI_MODEL: ${{ secrets.AZURE_OPENAI_MODEL || 'gpt-4.1-mini' }}
      run: |
        echo "ü§ñ Stage 9e: Generating AI multi-layer resolution report..."

        # Check if ORT results exist
        if [ ! -f ort-results/analyzer/analyzer-result.yml ]; then
          echo "‚ö†Ô∏è  ORT analyzer results not found, skipping..."
          exit 0
        fi

        # Check Azure credentials
        if [ -z "$AZURE_OPENAI_API_KEY" ]; then
          echo "‚ö†Ô∏è  Azure OpenAI not configured, skipping AI resolution report..."
          exit 0
        fi

        # Prepare parameters
        ORT_PARAM="--ort-result ort-results/analyzer/analyzer-result.yml"

        PYPI_PARAM=""
        if [ -f pypi-licenses/pypi-licenses-full.json ]; then
          PYPI_PARAM="--pypi-results pypi-licenses/pypi-licenses-full.json"
          echo "  ‚úì PyPI results found"
        fi

        SCANCODE_PARAM=""
        if [ -d scancode-results ] && [ "$(ls -A scancode-results)" ]; then
          SCANCODE_PARAM="--scancode-dir scancode-results"
          echo "  ‚úì ScanCode results found"
        fi

        UNCERTAIN_PARAM=""
        if [ -f uncertain-packages/uncertain-packages.json ]; then
          UNCERTAIN_PARAM="--uncertain-packages uncertain-packages/uncertain-packages.json"
          echo "  ‚úì Uncertain packages found"
        fi

        # Run AI resolution report
        echo "Running ai_multilayer_resolution.py..."
        python3 ai_multilayer_resolution.py \
          $ORT_PARAM \
          $PYPI_PARAM \
          $SCANCODE_PARAM \
          $UNCERTAIN_PARAM \
          --output ai-multilayer-resolution.html 2>&1 | tee ai-resolution.log

        # Verify output
        if [ -f ai-multilayer-resolution.html ] && [ -s ai-multilayer-resolution.html ]; then
          echo "‚úÖ AI multi-layer resolution report generated ($(wc -c < ai-multilayer-resolution.html) bytes)"
        else
          echo "‚ö†Ô∏è  AI resolution report generation failed or no issues found, check ai-resolution.log"
          cat ai-resolution.log || true
        fi
      continue-on-error: true

    # ====== STAGE 10: Prepare GitHub Pages ======
    - name: Prepare Pages Deployment
      run: |
        mkdir -p public

        echo "üì¶ Copying ORT reports..."
        if [ -d ort-results/reporter ]; then
          cp -r ort-results/reporter/* public/ 2>/dev/null || true
        fi

        echo "üì¶ Copying enhanced reports..."
        # Copy enhanced SPDX
        if [ -f enhanced-spdx/bom-enhanced-fixed.spdx.json ]; then
          cp enhanced-spdx/bom-enhanced-fixed.spdx.json public/bom-enhanced.spdx.json
        fi

        # Copy Policy Reports
        if [ -f policy-reports/policy-compliance-report.html ]; then
          cp policy-reports/policy-compliance-report.html public/
          echo "  ‚úì Policy compliance report"
        fi

        if [ -f policy-reports/license-changes-report.html ]; then
          cp policy-reports/license-changes-report.html public/
          echo "  ‚úì License changes report"
        fi

        # Copy Alternative Package Reports
        if [ -d alternatives ] && [ "$(ls -A alternatives)" ]; then
          mkdir -p public/alternatives
          cp alternatives/*.html public/alternatives/ 2>/dev/null || true
          ALTERNATIVES_COUNT=$(ls -1 alternatives/*.html 2>/dev/null | wc -l)
          echo "  ‚úì Copied $ALTERNATIVES_COUNT alternative package reports"
        fi

        # Copy AI curation reports
        if [ -f curation-report-main.html ]; then
          cp curation-report-main.html public/
          echo "  ‚úì Main ORT curation report"
        fi

        if [ -f curation-report-conflicts.html ]; then
          cp curation-report-conflicts.html public/
          echo "  ‚úì Conflict analysis report"
        fi

        if [ -f curation-report-missing-licenses.html ]; then
          cp curation-report-missing-licenses.html public/
          echo "  ‚úì Missing licenses AI analysis report"
        fi

        # Copy license comparison report
        if [ -f license-comparison.html ]; then
          cp license-comparison.html public/
          echo "  ‚úì Multi-layer license comparison report"
        fi

        # Copy AI multi-layer resolution report
        if [ -f ai-multilayer-resolution.html ]; then
          cp ai-multilayer-resolution.html public/
          echo "  ‚úì AI multi-layer resolution report"
        fi

        # Copy any timestamped reports too
        if ls curation-report-*.html 1> /dev/null 2>&1; then
          for report in curation-report-*.html; do
            [ -f "$report" ] && cp "$report" public/ 2>/dev/null || true
          done
        fi

        # Copy native ScanCode reports (HTML, JSON, YAML)
        if [ -d scancode-results ] && [ "$(ls -A scancode-results)" ]; then
          mkdir -p public/scancode-reports
          cp scancode-results/*.html public/scancode-reports/ 2>/dev/null || true
          cp scancode-results/*.json public/scancode-reports/ 2>/dev/null || true
          cp scancode-results/*.yml public/scancode-reports/ 2>/dev/null || true

          SCANCODE_COUNT=$(ls -1 scancode-results/*.html 2>/dev/null | wc -l)
          echo "  ‚úì Copied $SCANCODE_COUNT ScanCode native reports"
        fi

        # Copy ScanCode summary reports
        if [ -f scancode-summary.html ]; then
          cp scancode-summary.html public/
          echo "  ‚úì ScanCode HTML summary"
        fi

        if [ -f scancode-summary.yml ]; then
          cp scancode-summary.yml public/
          echo "  ‚úì ScanCode YAML summary"
        fi

        # Copy ScanCode merge report
        if [ -f enhanced-spdx/merge-report.md ]; then
          cp enhanced-spdx/merge-report.md public/
          echo "  ‚úì ScanCode merge report"
        fi

        # Copy uncertain packages report
        if [ -f uncertain-packages/report.md ]; then
          cp uncertain-packages/report.md public/uncertain-packages-report.md
        fi

        # Copy PyPI license fetch results
        if [ -d pypi-licenses ] && [ "$(ls -A pypi-licenses)" ]; then
          # Copy HTML report to public root for easy access
          if [ -f pypi-licenses/pypi-licenses-report.html ]; then
            cp pypi-licenses/pypi-licenses-report.html public/
            echo "  ‚úì PyPI HTML report"
          fi

          # Copy all other files to subdirectory
          mkdir -p public/pypi-licenses
          cp pypi-licenses/*.json public/pypi-licenses/ 2>/dev/null || true
          cp pypi-licenses/*.csv public/pypi-licenses/ 2>/dev/null || true
          cp pypi-licenses/*.yml public/pypi-licenses/ 2>/dev/null || true
          cp pypi-licenses/*.txt public/pypi-licenses/ 2>/dev/null || true
          echo "  ‚úì PyPI license fetch results"
        fi

        # Copy background image
        if [ -f background.jpg ] || [ -f background.png ]; then
          cp background.* public/ 2>/dev/null || true
        fi

        # Detect generated files
        echo "üìÇ Detecting generated files..."
        ls -la public/

        # Generate landing page using Python script
        python3 generate_landing_page.py public

        echo "‚úÖ Landing page generated with all available reports"

    # ====== STAGE 11: Deploy to GitHub Pages ======
    - name: Setup Pages
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: actions/configure-pages@v4

    - name: Upload Pages Artifact
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'public'

    - name: Deploy to GitHub Pages
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      id: deployment
      uses: actions/deploy-pages@v4

    # ====== STAGE 12: Upload Artifacts ======
    - name: Upload all ORT results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ort-results-${{ github.ref_name }}-${{ github.run_number }}
        path: ort-results/
        retention-days: 30

    - name: Upload ScanCode results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scancode-results-${{ github.ref_name }}-${{ github.run_number }}
        path: scancode-results/
        retention-days: 30

    - name: Upload policy reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: policy-reports-${{ github.ref_name }}-${{ github.run_number }}
        path: |
          policy-reports/
          license-history/
          alternatives/
        retention-days: 30

    - name: Upload enhanced reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: enhanced-reports-${{ github.ref_name }}-${{ github.run_number }}
        path: |
          curation-report-*.html
          enhanced-spdx/
          uncertain-packages/
          pypi-licenses/
        retention-days: 30

    # ====== STAGE 13: Summary & PR Comment ======
    - name: Generate workflow summary
      id: summary
      run: |
        echo "## üîç Advanced License Curation Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Multi-Tool Analysis with Policy Enforcement Complete**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tools Used:" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ ORT Analyzer & Advisor" >> $GITHUB_STEP_SUMMARY
        echo "- üîí License Policy Checker (Company Policy Enforcement)" >> $GITHUB_STEP_SUMMARY
        echo "- üîÑ License Change Monitor (Historical Tracking)" >> $GITHUB_STEP_SUMMARY
        echo "- üîç Alternative Package Finder (Forbidden License Replacement)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ PyPI API License Fetcher (fast license retrieval)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ ScanCode Toolkit (deep license scanning)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ SPDX Validation & Enhancement" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Azure OpenAI GPT-4 (AI curation)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f uncertain-packages/extraction-stats.txt ]; then
          echo "### üìä License Coverage:" >> $GITHUB_STEP_SUMMARY
          cat uncertain-packages/extraction-stats.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "### üì¶ Generated Reports:" >> $GITHUB_STEP_SUMMARY
        echo "- Policy compliance report with approval status" >> $GITHUB_STEP_SUMMARY
        echo "- License change detection with severity assessment" >> $GITHUB_STEP_SUMMARY
        echo "- Alternative package recommendations" >> $GITHUB_STEP_SUMMARY
        echo "- Enhanced AI curation report" >> $GITHUB_STEP_SUMMARY
        echo "- SPDX document (enhanced with ScanCode)" >> $GITHUB_STEP_SUMMARY
        echo "- CycloneDX SBOM" >> $GITHUB_STEP_SUMMARY
        echo "- Uncertain packages analysis" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true

    - name: Comment PR with advanced results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          let comment = '## üîç Advanced License Curation Analysis Results\n\n';
          comment += '‚úÖ Multi-tool analysis with policy enforcement completed!\n\n';
          comment += '### üõ†Ô∏è Analysis Pipeline\n\n';
          comment += '1. **ORT Analyzer** - Dependency analysis\n';
          comment += '2. **Policy Checker** - Company license policy enforcement\n';
          comment += '3. **License Change Monitor** - Historical tracking and change detection\n';
          comment += '4. **Alternative Finder** - Replacement packages for forbidden licenses\n';
          comment += '5. **PyPI API Fetch** - Fast license retrieval from package registries\n';
          comment += '6. **ScanCode Toolkit** - Deep license detection (optimized)\n';
          comment += '7. **SPDX Enhancement** - Merge & validation\n';
          comment += '8. **AI Curation** - GPT-4 powered recommendations\n\n';
          comment += '### üìä View Reports\n\n';
          comment += '- üåê [All Reports (GitHub Pages)](https://' + context.repo.owner + '.github.io/' + context.repo.repo + '/)\n';
          comment += '- üì• [Download All Artifacts](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')\n\n';
          comment += '**Advanced Features:**\n';
          comment += '- ‚úÖ Automated policy compliance checking\n';
          comment += '- ‚úÖ License change detection with severity assessment\n';
          comment += '- ‚úÖ Alternative package recommendations for forbidden licenses\n';
          comment += '- ‚úÖ PyPI API fetched licenses for PyPI packages (fast)\n';
          comment += '- ‚úÖ ScanCode enhanced remaining packages\n';
          comment += '- ‚úÖ AI analyzed license conflicts with actionable recommendations\n';
          comment += '- ‚úÖ Validated and fixed SPDX compliance issues\n\n';
          comment += '---\n';
          comment += '*üí° Advanced multi-tool approach with policy enforcement maximizes license detection and compliance*\n';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      continue-on-error: true
