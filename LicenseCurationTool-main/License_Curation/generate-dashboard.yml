name: Generate ORT Dashboard

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  collect-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout dashboard repo
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Collect ORT results from repositories
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          const fs = require('fs');
          
          // üîß CUSTOMIZE THIS: List all your target repositories
          const repos = [
            'arkawick/scipy',
            'arkawick/numpy'
          ];
          
          const results = [];
          
          for (const repo of repos) {
            const [owner, repoName] = repo.split('/');
            
            try {
              console.log(`üìä Fetching latest ORT run for ${repo}...`);
              
              // Get latest workflow runs
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo: repoName,
                status: 'completed',
                per_page: 20
              });
              
              // Find ORT workflow runs
              const ortRuns = runs.data.workflow_runs.filter(run => 
                run.name.includes('ORT') || 
                run.path.includes('ort-analysis')
              );
              
              if (ortRuns.length === 0) {
                console.log(`‚ö†Ô∏è No ORT runs found for ${repo}`);
                results.push({
                  repo,
                  status: 'no-runs',
                  lastRun: 'Never',
                  vulnerabilities: 'Unknown',
                  pagesUrl: `https://${owner}.github.io/${repoName}/`
                });
                continue;
              }
              
              const latestRun = ortRuns[0];
              
              // Get artifacts
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo: repoName,
                run_id: latestRun.id
              });
              
              // Analyze artifacts for vulnerability info
              const hasVulnArtifact = artifacts.data.artifacts.some(a => 
                a.name.includes('vulnerabilit') || a.name.includes('advisor')
              );
              
              const vulnStatus = latestRun.conclusion === 'failure' ? '‚ö†Ô∏è Found' :
                               latestRun.conclusion === 'success' ? '‚úÖ None' : '‚ùì Unknown';
              
              results.push({
                repo,
                status: latestRun.conclusion,
                lastRun: latestRun.updated_at,
                runUrl: latestRun.html_url,
                artifactCount: artifacts.data.artifacts.length,
                vulnerabilities: vulnStatus,
                pagesUrl: `https://${owner}.github.io/${repoName}/`,
                branch: latestRun.head_branch
              });
              
              console.log(`‚úÖ Processed ${repo}`);
              
            } catch (error) {
              console.error(`‚ùå Error processing ${repo}: ${error.message}`);
              results.push({
                repo,
                status: 'error',
                error: error.message,
                lastRun: 'Error',
                vulnerabilities: 'Error'
              });
            }
          }
          
          // Save results
          fs.writeFileSync('dashboard-data.json', JSON.stringify(results, null, 2));
          console.log(`\nüìù Collected data for ${results.length} repositories`);
    
    - name: Generate Dashboard HTML
      run: |
        mkdir -p public
        
        cat > public/index.html << 'HTMLEOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Multi-Repository ORT Dashboard</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              padding: 20px;
            }
            
            .container {
              max-width: 1400px;
              margin: 0 auto;
              background: white;
              border-radius: 16px;
              padding: 40px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
            
            header {
              margin-bottom: 40px;
            }
            
            h1 {
              color: #2d3748;
              margin-bottom: 10px;
              font-size: 2.5rem;
              display: flex;
              align-items: center;
              gap: 15px;
            }
            
            .subtitle {
              color: #718096;
              font-size: 1.1rem;
            }
            
            .stats {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
              gap: 20px;
              margin-bottom: 40px;
            }
            
            .stat-card {
              background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
              border-radius: 12px;
              padding: 24px;
              text-align: center;
              border: 2px solid #e2e8f0;
              transition: transform 0.2s;
            }
            
            .stat-card:hover {
              transform: translateY(-5px);
              box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            }
            
            .stat-icon {
              font-size: 2.5rem;
              margin-bottom: 10px;
            }
            
            .stat-value {
              font-size: 2.5rem;
              font-weight: 700;
              color: #667eea;
              margin-bottom: 5px;
            }
            
            .stat-label {
              color: #718096;
              font-size: 0.95rem;
              font-weight: 500;
            }
            
            .table-container {
              overflow-x: auto;
              border-radius: 12px;
              border: 1px solid #e2e8f0;
            }
            
            table {
              width: 100%;
              border-collapse: collapse;
            }
            
            thead {
              background: #f7fafc;
            }
            
            th {
              padding: 16px;
              text-align: left;
              font-weight: 600;
              color: #2d3748;
              border-bottom: 2px solid #e2e8f0;
              white-space: nowrap;
            }
            
            td {
              padding: 16px;
              border-bottom: 1px solid #e2e8f0;
            }
            
            tbody tr:hover {
              background: #f7fafc;
            }
            
            tbody tr:last-child td {
              border-bottom: none;
            }
            
            .repo-name {
              font-weight: 600;
              color: #2d3748;
            }
            
            .status-badge {
              display: inline-block;
              padding: 6px 14px;
              border-radius: 20px;
              font-size: 0.85rem;
              font-weight: 600;
              white-space: nowrap;
            }
            
            .status-success {
              background: #c6f6d5;
              color: #22543d;
            }
            
            .status-failure {
              background: #fed7d7;
              color: #742a2a;
            }
            
            .status-error {
              background: #feebc8;
              color: #7c2d12;
            }
            
            .status-no-runs {
              background: #e2e8f0;
              color: #4a5568;
            }
            
            .btn-link {
              display: inline-block;
              padding: 8px 16px;
              background: #667eea;
              color: white;
              text-decoration: none;
              border-radius: 8px;
              font-size: 0.9rem;
              font-weight: 500;
              transition: all 0.2s;
            }
            
            .btn-link:hover {
              background: #5568d3;
              transform: translateY(-2px);
              box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }
            
            .btn-secondary {
              background: #718096;
              margin-left: 8px;
            }
            
            .btn-secondary:hover {
              background: #4a5568;
            }
            
            .footer {
              margin-top: 40px;
              padding-top: 20px;
              border-top: 1px solid #e2e8f0;
              text-align: center;
              color: #718096;
              font-size: 0.9rem;
            }
            
            .refresh-badge {
              display: inline-block;
              background: #e6fffa;
              color: #234e52;
              padding: 8px 16px;
              border-radius: 8px;
              font-weight: 500;
              margin-top: 10px;
            }
            
            .loading {
              text-align: center;
              padding: 40px;
              color: #718096;
            }
            
            .error-message {
              background: #fed7d7;
              color: #742a2a;
              padding: 16px;
              border-radius: 8px;
              margin-bottom: 20px;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <header>
              <h1>
                üè¢ Multi-Repository ORT Dashboard
              </h1>
              <p class="subtitle">Centralized Open Source Review Toolkit Analysis & Compliance Monitoring</p>
            </header>
            
            <div class="stats">
              <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="total-repos">-</div>
                <div class="stat-label">Total Repositories</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="success-count">-</div>
                <div class="stat-label">Successful Scans</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-value" id="vuln-count">-</div>
                <div class="stat-label">With Issues</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">üîÑ</div>
                <div class="stat-value" id="last-scan">-</div>
                <div class="stat-label">Hours Since Last Scan</div>
              </div>
            </div>
            
            <div class="table-container">
              <table id="results-table">
                <thead>
                  <tr>
                    <th>Repository</th>
                    <th>Status</th>
                    <th>Vulnerabilities</th>
                    <th>Last Run</th>
                    <th>Branch</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="6" class="loading">Loading dashboard data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div class="footer">
              <div>Last updated: <strong id="last-update">-</strong></div>
              <div class="refresh-badge">üîÑ Auto-refreshes every 6 hours</div>
            </div>
          </div>
          
          <script>
            function formatDate(dateString) {
              if (dateString === 'Never' || dateString === 'Error') return dateString;
              const date = new Date(dateString);
              return date.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
            
            function calculateHoursSince(dateString) {
              if (!dateString || dateString === 'Never' || dateString === 'Error') return '-';
              const date = new Date(dateString);
              const now = new Date();
              const hours = Math.floor((now - date) / (1000 * 60 * 60));
              return hours;
            }
            
            fetch('dashboard-data.json')
              .then(res => {
                if (!res.ok) throw new Error('Failed to load dashboard data');
                return res.json();
              })
              .then(data => {
                // Update statistics
                document.getElementById('total-repos').textContent = data.length;
                document.getElementById('success-count').textContent = 
                  data.filter(r => r.status === 'success').length;
                document.getElementById('vuln-count').textContent = 
                  data.filter(r => r.vulnerabilities && r.vulnerabilities.includes('Found')).length;
                
                // Calculate most recent scan
                const recentDates = data
                  .map(r => r.lastRun)
                  .filter(d => d && d !== 'Never' && d !== 'Error')
                  .map(d => new Date(d))
                  .sort((a, b) => b - a);
                
                if (recentDates.length > 0) {
                  const hours = calculateHoursSince(recentDates[0]);
                  document.getElementById('last-scan').textContent = hours;
                }
                
                // Populate table
                const tbody = document.querySelector('#results-table tbody');
                tbody.innerHTML = '';
                
                data.forEach(result => {
                  const row = tbody.insertRow();
                  
                  let statusClass = 'status-no-runs';
                  let statusText = result.status;
                  
                  if (result.status === 'success') {
                    statusClass = 'status-success';
                    statusText = '‚úÖ Success';
                  } else if (result.status === 'failure') {
                    statusClass = 'status-failure';
                    statusText = '‚ùå Failed';
                  } else if (result.status === 'error') {
                    statusClass = 'status-error';
                    statusText = '‚ö†Ô∏è Error';
                  } else if (result.status === 'no-runs') {
                    statusText = '‚ûñ No Runs';
                  }
                  
                  row.innerHTML = `
                    <td><span class="repo-name">${result.repo}</span></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${result.vulnerabilities || 'Unknown'}</td>
                    <td>${formatDate(result.lastRun)}</td>
                    <td>${result.branch || '-'}</td>
                    <td>
                      ${result.pagesUrl ? `<a href="${result.pagesUrl}" class="btn-link" target="_blank">üìä Reports</a>` : ''}
                      ${result.runUrl ? `<a href="${result.runUrl}" class="btn-link btn-secondary" target="_blank">üîç Details</a>` : ''}
                    </td>
                  `;
                });
                
                // Update timestamp
                document.getElementById('last-update').textContent = 
                  new Date().toLocaleString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                  });
              })
              .catch(error => {
                console.error('Error loading dashboard:', error);
                const tbody = document.querySelector('#results-table tbody');
                tbody.innerHTML = `
                  <tr>
                    <td colspan="6" class="error-message">
                      ‚ùå Failed to load dashboard data: ${error.message}
                    </td>
                  </tr>
                `;
              });
          </script>
        </body>
        </html>
        HTMLEOF
        
        # Copy data file
        cp dashboard-data.json public/
        
        echo "‚úÖ Dashboard HTML generated successfully"
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'public'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Output deployment URL
      run: |
        echo "## üöÄ Dashboard Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üåê **Dashboard URL:** https://arkawick.github.io/ort-dashboard/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìä The dashboard shows the latest ORT analysis results from all monitored repositories." >> $GITHUB_STEP_SUMMARY
